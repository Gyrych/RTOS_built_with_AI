# STM32F407 TIM2高精度延时系统

## 概述

本项目实现了基于STM32F407 TIM2定时器的高精度延时功能，支持毫秒、微秒、纳秒级延时，并完全集成RTOS任务调度系统。

## 功能特性

### 1. 高精度延时
- **毫秒级延时**: `Delay_ms(uint32_t ms)` - 支持1ms到约49.7天的延时
- **微秒级延时**: `Delay_us(uint32_t us)` - 支持1μs到约49.7天的延时  
- **纳秒级延时**: `Delay_ns(uint32_t ns)` - 支持100ns到约49.7天的延时

### 2. RTOS集成
- 延时期间任务自动挂起，释放CPU资源
- 定时器到时后任务自动恢复，进行任务调度
- 支持多任务并发，延时期间其他任务正常运行

### 3. 技术规格
- **定时器**: TIM2 (32位定时器)
- **时钟频率**: 84MHz (APB1总线)
- **精度**: 约12ns/时钟周期
- **最小延时**: 100ns
- **中断优先级**: 3 (高于PendSV，低于SVC)

## 文件结构

```
02_rtos/
├── time.h              # 延时函数头文件
├── time.c              # 延时函数实现
├── core.h              # RTOS核心头文件
└── core.c              # RTOS核心实现

User/
├── main.c              # 主程序（已更新）
└── config/stm32f4/core/
    ├── main.h          # 主头文件（已更新）
    ├── stm32f4xx_it.h  # 中断头文件（已更新）
    └── stm32f4xx_it.c  # 中断处理文件（已更新）
```

## 使用方法

### 1. 初始化
```c
#include "../../02_rtos/time.h"

int main(void)
{
    SystemInit();
    Time_Init();  // 初始化延时系统
    // ... 其他初始化代码
}
```

### 2. 延时函数调用
```c
// 毫秒级延时
Delay_ms(100);    // 延时100毫秒

// 微秒级延时  
Delay_us(1000);   // 延时1000微秒(1毫秒)

// 纳秒级延时
Delay_ns(100000); // 延时100000纳秒(100微秒)
```

### 3. 在RTOS任务中使用
```c
void my_task(void* arg)
{
    while(1)
    {
        // 执行任务逻辑
        do_something();
        
        // 延时期间任务挂起，其他任务可以运行
        Delay_ms(100);
        
        // 延时完成后任务自动恢复
        do_something_else();
    }
}
```

## 实现原理

### 1. 定时器配置
- TIM2配置为32位向上计数模式
- 无分频，直接使用84MHz时钟
- 使用比较中断(CC1)触发延时完成

### 2. 延时流程
1. 调用延时函数时，计算目标计数值
2. 设置TIM2比较寄存器为目标值
3. 挂起当前任务，进行RTOS调度
4. 其他任务获得CPU时间运行
5. TIM2比较中断触发时，恢复等待任务
6. 再次进行RTOS调度

### 3. 精度保证
- 使用硬件定时器，精度不受软件影响
- 84MHz时钟提供约12ns的计时精度
- 中断响应时间约100ns级别

## 测试验证

项目中的测试代码展示了不同精度延时的使用：

### LED闪烁任务
```c
void task_led_blink(void* arg)
{
    while(1)
    {
        LED_ON();
        Delay_ms(200);    // 200ms延时
        
        LED_OFF(); 
        Delay_ms(800);    // 800ms延时
        
        // 测试微秒级延时
        LED_ON();
        Delay_us(1000);   // 1ms延时
        
        LED_OFF();
        Delay_us(5000);   // 5ms延时
        
        // 测试纳秒级延时
        LED_ON();
        Delay_ns(100000); // 100μs延时
        
        LED_OFF();
        Delay_ns(500000); // 500μs延时
    }
}
```

## 注意事项

1. **最小延时限制**: 纳秒级延时最小为100ns，小于此值会被自动调整
2. **最大延时限制**: 受32位计数器限制，最大延时约49.7天
3. **中断优先级**: TIM2中断优先级设为3，确保延时精度
4. **任务调度**: 延时期间会进行任务调度，确保系统响应性
5. **资源占用**: 使用TIM2定时器，请确保不与其他功能冲突

## 性能特点

- **高精度**: 100ns级别的延时精度
- **低功耗**: 延时期间CPU可运行其他任务
- **实时性**: 硬件定时器保证实时性
- **可扩展**: 支持多任务并发延时
- **易用性**: 简单的API接口

## 编译配置

确保在编译时包含以下文件：
- `02_rtos/time.c`
- `02_rtos/time.h`
- `02_rtos/core.c`
- `02_rtos/core.h`
- 更新后的`User/main.c`和中断处理文件

## 总结

本实现成功地将STM32F407的TIM2定时器与自定义RTOS系统集成，提供了高精度、低功耗的延时功能。通过硬件定时器和软件任务调度的结合，实现了既精确又高效的延时系统，满足了嵌入式实时系统的需求。
