# RTOS Tickless版本编译脚本
# 无滴答时钟 + 完全抢占式调度 + 动态定时器延时

# 编译器设置
CC = arm-none-eabi-gcc
AS = arm-none-eabi-as
LD = arm-none-eabi-ld
OBJCOPY = arm-none-eabi-objcopy
OBJDUMP = arm-none-eabi-objdump
SIZE = arm-none-eabi-size

# 目标名称
TARGET = rtos_tickless

# 编译选项
CFLAGS = -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 \
         -Wall -Wextra -std=c99 -O2 -g \
         -ffunction-sections -fdata-sections \
         -DUSE_STDPERIPH_DRIVER -DSTM32F407xx \
         -DRTOS_TICKLESS_ENABLE

ASFLAGS = -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16

LDFLAGS = -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 \
          -Wl,--gc-sections -Wl,--print-memory-usage \
          -TSTM32F407VGTx_FLASH.ld

# 源文件目录
SRC_DIRS = . \
           rtos/core \
           rtos/task \
           rtos/sync \
           rtos/time \
           rtos/memory \
           rtos/hw

# 头文件目录
INC_DIRS = . \
           rtos/core \
           rtos/task \
           rtos/sync \
           rtos/time \
           rtos/memory \
           rtos/hw

# 源文件列表
SRCS = main_tickless.c \
       system_support.c \
       rtos/system.c \
       rtos/core/object.c \
       rtos/task/task.c \
       rtos/sync/semaphore.c \
       rtos/sync/mutex.c \
       rtos/sync/queue.c \
       rtos/time/timer.c \
       rtos/time/tickless.c \
       rtos/time/dynamic_delay.c \

       rtos/hw/hw_abstraction.c \
       rtos/hw/interrupt_handler.c

# 汇编文件
ASMS = startup_stm32f407xx.s

# 生成目标文件列表
OBJS = $(SRCS:.c=.o) $(ASMS:.s=.o)

# 生成依赖文件列表
DEPS = $(SRCS:.c=.d)

# 默认目标
all: $(TARGET).elf $(TARGET).hex $(TARGET).bin size

# 链接生成ELF文件
$(TARGET).elf: $(OBJS)
	@echo "链接 $(TARGET).elf (Tickless版本)"
	$(CC) $(LDFLAGS) -o $@ $^
	@echo "Tickless RTOS链接完成"

# 生成HEX文件
$(TARGET).hex: $(TARGET).elf
	@echo "生成 $(TARGET).hex"
	$(OBJCOPY) -O ihex $< $@

# 生成BIN文件
$(TARGET).bin: $(TARGET).elf
	@echo "生成 $(TARGET).bin"
	$(OBJCOPY) -O binary $< $@

# 编译C源文件
%.o: %.c
	@echo "编译 $<"
	$(CC) $(CFLAGS) $(addprefix -I,$(INC_DIRS)) -c $< -o $@

# 编译汇编文件
%.o: %.s
	@echo "汇编 $<"
	$(AS) $(ASFLAGS) $< -o $@

# 生成依赖文件
%.d: %.c
	@echo "生成依赖 $<"
	$(CC) $(CFLAGS) $(addprefix -I,$(INC_DIRS)) -MM -MT $(@:.d=.o) $< > $@

# 显示文件大小信息
size: $(TARGET).elf
	@echo "Tickless RTOS程序大小信息:"
	$(SIZE) $<
	@echo ""
	@echo "特性说明:"
	@echo "  ✓ 无系统滴答时钟"
	@echo "  ✓ 完全基于优先级抢占调度"
	@echo "  ✓ 动态定时器设置系统延时"
	@echo "  ✓ 高精度时间管理(纳秒级)"

# 清理目标
clean:
	@echo "清理Tickless版本编译文件"
	rm -f $(OBJS) $(DEPS) $(TARGET).elf $(TARGET).hex $(TARGET).bin
	@echo "清理完成"

# 重新编译
rebuild: clean all

# 显示帮助信息
help:
	@echo "RTOS Tickless版本编译脚本"
	@echo ""
	@echo "特性:"
	@echo "  - 无系统滴答时钟 (Tickless)"
	@echo "  - 完全基于优先级的抢占式调度"
	@echo "  - 动态定时器设置系统延时"
	@echo "  - 高精度时间管理"
	@echo ""
	@echo "可用目标:"
	@echo "  all      - 编译所有文件 (默认)"
	@echo "  clean    - 清理编译文件"
	@echo "  rebuild  - 重新编译"
	@echo "  help     - 显示此帮助信息"
	@echo ""
	@echo "生成文件:"
	@echo "  $(TARGET).elf - ELF格式可执行文件"
	@echo "  $(TARGET).hex - Intel HEX格式文件"
	@echo "  $(TARGET).bin - 二进制格式文件"

# 包含依赖文件
-include $(DEPS)

# 伪目标声明
.PHONY: all clean rebuild help size