# STM32F407 RTOS 项目

## 项目概述

本项目是一个基于STM32F407VGTx微控制器的**自定义RTOS（实时操作系统）**项目，旨在学习和实现嵌入式实时操作系统的核心功能。项目集成了高精度延时系统，支持毫秒、微秒、纳秒级延时，并实现了完整的多任务调度机制。

## 项目特色

### 🚀 核心功能
- **自定义RTOS系统** - 从零开始实现的任务调度器
- **Tickless架构** - 不使用SysTick周期性中断，事件驱动
- **高精度延时** - 基于TIM2的100ns级别精确延时
- **多任务调度** - 支持32个任务，31级优先级
- **上下文切换** - 完整的任务上下文保存和恢复
- **中断管理** - 优化的中断优先级配置

### 🎯 技术亮点
- **抢占式调度** - 基于优先级的任务抢占
- **Tickless设计** - 无周期性中断，降低功耗和系统开销
- **硬件定时器集成** - TIM2定时器与RTOS无缝集成
- **低功耗设计** - 空闲任务使用WFI指令，无周期性中断
- **实时性保证** - 硬件中断确保实时响应

## 硬件平台

- **微控制器**: STM32F407VGTx (Cortex-M4, 168MHz)
- **开发板**: 星火一号开发板
- **LED指示**: GPIOF Pin 11
- **调试接口**: ST-Link/V2 或 J-Link

## 项目结构

```
RTOS_built_with_AI/
├── 00_project/                    # 项目配置和用户代码
│   ├── EIDE/                      # EIDE项目配置
│   │   ├── build/                 # 编译输出目录
│   │   ├── STM32F407VGTx_FLASH.ld # 链接脚本
│   │   └── EIDE.code-workspace    # 工作空间配置
│   └── User/                      # 用户应用代码
│       ├── main.c                 # 主程序（多任务演示）
│       ├── config/stm32f4/        # STM32F4配置
│       │   ├── core/              # 启动文件和系统文件
│       │   └── config/            # 外设配置文件
│       └── TIM2_DELAY_README.md   # 延时系统详细说明
├── 01_fwlib/                      # STM32F4标准外设库
│   ├── CMSIS/                     # ARM CMSIS核心文件
│   ├── inc/                       # 外设库头文件
│   └── src/                       # 外设库源文件
├── 02_rtos/                       # 自定义RTOS实现
│   ├── core.h                     # RTOS核心头文件
│   ├── core.c                     # RTOS核心实现
│   ├── time.h                     # 高精度延时头文件
│   └── time.c                     # 高精度延时实现
└── README.md                      # 项目说明文档（本文件）
```

## 快速开始

### 环境要求

- **开发环境**: VSCode + EIDE扩展
- **编译器**: ARM GCC (arm-none-eabi-gcc)
- **调试器**: ST-Link/V2 或 J-Link
- **操作系统**: Windows/Linux/macOS

### 编译和烧录

1. **克隆项目**
   ```bash
   git clone <repository-url>
   cd RTOS_built_with_AI/00_project/EIDE
   ```

2. **编译项目**
   ```bash
   eide build
   ```

3. **烧录到设备**
   ```bash
   eide upload
   ```

4. **调试项目**
   ```bash
   eide debug
   ```

### 运行效果

程序运行后会创建三个任务：

1. **LED闪烁任务** (优先级1) - 演示不同精度的延时
   - 200ms/800ms 毫秒级延时
   - 1ms/5ms 微秒级延时  
   - 100μs/500μs 纳秒级延时

2. **串口打印任务** (优先级2) - 测试延时系统
   - 500ms + 100ms + 1ms 组合延时

3. **按钮检测任务** (优先级3) - 高频延时测试
   - 10ms + 100μs 高频延时

## 技术实现

### RTOS核心架构

#### 任务管理
```c
typedef struct {
    void (*task_func)(void*);  // 任务函数指针
    void* arg;                 // 任务参数
    uint32_t* stack_ptr;       // 当前堆栈指针
    uint32_t priority;         // 任务优先级 (0-31)
    uint8_t state;             // 任务状态
    uint32_t stack[STACK_SIZE]; // 任务堆栈空间
} task_t;
```

#### 调度策略
- **抢占式调度**: 高优先级任务可以抢占低优先级任务
- **优先级范围**: 0（最高）到31（最低）
- **任务状态**: READY（就绪）、RUNNING（运行）、SUSPENDED（挂起）

#### 上下文切换
- 使用PendSV中断进行上下文切换
- 保存/恢复R4-R11寄存器
- 支持Cortex-M4的异常返回机制

### 高精度延时系统

#### 技术规格
- **定时器**: TIM2 (32位定时器)
- **时钟频率**: 84MHz
- **精度**: 约12ns/时钟周期
- **最小延时**: 100ns
- **最大延时**: 约49.7天

#### 延时函数
```c
void Delay_ms(uint32_t ms);  // 毫秒级延时
void Delay_us(uint32_t us);  // 微秒级延时
void Delay_ns(uint32_t ns);  // 纳秒级延时
```

#### 实现原理
1. 延时开始时挂起当前任务
2. 设置TIM2比较寄存器为目标值
3. 进行RTOS任务调度，让出CPU
4. TIM2中断触发时恢复等待任务
5. 再次进行任务调度

## 开发计划

### 已完成功能 ✅
- [x] 基础RTOS任务调度器
- [x] 优先级抢占式调度
- [x] 任务上下文切换
- [x] 高精度延时系统
- [x] 多任务演示程序
- [x] 中断优先级配置
- [x] 代码整理和注释完善

### 计划功能 🚧
- [ ] 信号量（Semaphore）机制
- [ ] 互斥锁（Mutex）实现
- [ ] 消息队列（Message Queue）
- [ ] 事件标志组（Event Flags）
- [ ] 软件定时器（Software Timer）
- [ ] 内存管理（Memory Management）
- [ ] 任务间通信（IPC）
- [ ] 系统监控和调试工具

### 优化计划 🔄
- [ ] 任务调度算法优化
- [ ] 内存使用优化
- [ ] 中断响应时间优化
- [ ] 功耗管理优化
- [ ] 代码模块化重构
- [ ] 单元测试框架
- [ ] 性能基准测试

## 学习价值

### 嵌入式系统概念
- **实时操作系统原理** - 理解RTOS的核心概念
- **任务调度算法** - 学习抢占式调度实现
- **上下文切换** - 掌握CPU状态保存和恢复
- **中断管理** - 理解中断优先级和嵌套

### 硬件编程技能
- **STM32F4外设编程** - 定时器、GPIO、中断配置
- **ARM Cortex-M4架构** - 处理器特性和指令集
- **链接脚本** - 内存布局和程序链接
- **调试技巧** - 使用调试器分析程序行为

### 软件工程实践
- **模块化设计** - 代码组织和接口设计
- **文档编写** - 技术文档和注释规范
- **版本控制** - Git使用和项目管理
- **测试驱动开发** - 单元测试和集成测试

## 贡献指南

欢迎对项目进行贡献！请遵循以下步骤：

1. **Fork项目** - 创建自己的分支
2. **创建功能分支** - `git checkout -b feature/new-feature`
3. **提交更改** - `git commit -m "Add new feature"`
4. **推送分支** - `git push origin feature/new-feature`
5. **创建Pull Request** - 描述你的更改

### 代码规范
- 使用4个空格缩进
- 函数和变量使用驼峰命名法
- 添加详细的注释说明
- 遵循STM32标准库的代码风格

## 许可证

本项目采用MIT许可证 - 详见 [LICENSE](LICENSE) 文件

## 联系方式

- **项目维护者**: RTOS Team
- **邮箱**: [your-email@example.com]
- **GitHub**: [your-github-profile]

## 致谢

感谢以下开源项目和技术资源：

- **STM32F4标准外设库** - STMicroelectronics
- **ARM CMSIS** - ARM Limited
- **EIDE** - 嵌入式开发环境
- **RT-Thread** - 开源RTOS参考

---

**注意**: 本项目仅用于学习和研究目的，不适用于生产环境。在生产环境中使用前，请进行充分的测试和验证。
